# TO-DOS

## Skip Extraction Refinement for Short Formal Texts - 2025-11-18 22:48

- **Add fast-path for short formal texts to skip extraction retries** - For short, simple formal texts (e.g., "x > 5"), iterative refinement is likely unnecessary overhead since the 5-phase prompt should get it right on first attempt. **Problem:** Currently all extraction attempts go through the full retry loop with conversation-based refinement (up to 5 attempts checking degradation). For simple inputs, this wastes API calls and time. Similar to formalization's skip optimization (formalization_skip_threshold=20 chars), extraction should have a way to skip retries for trivial cases. **Files:** `src/domain/steps/extraction.py:52-147` (execute method and retry loop), `src/shared/config.py:100-115` (extraction settings). **Solution:** Add extraction_skip_retries_threshold config (e.g., 50 chars). If formal_text length < threshold, accept first attempt regardless of degradation (with logging). Still compute degradation for metrics, but don't retry. Rationale: Short texts like "x > 5" should produce simple SMT-LIB that's correct on first try with the comprehensive 5-phase prompt.

## ✅ COMPLETED: Enforce Zero Temperature for Extraction - 2025-11-18 22:19

- **DONE: Verified and documented extraction temperature stays at 0.0** - Confirmed extraction uses deterministic temperature (0.0) for all attempts with no variations. **Verification:** (1) Temperature hardcoded to 0.0 in `src/infrastructure/llm/client.py:238`, (2) No extraction temperature settings exist in `src/shared/config.py`, (3) Retry loop in `src/domain/steps/extraction.py` does not pass temperature parameter - only detail_level varies. **Documentation added:** Added CRITICAL warning in extract_to_smtlib docstring emphasizing temperature is non-configurable by design, expanded inline comment to 3-line warning at temperature=0.0 assignment, added NOTE in retry loop documenting temperature stays constant across all attempts. **Rationale:** Unlike formalization, extraction must be deterministic to ensure consistent, reproducible SMT-LIB output.

## ✅ COMPLETED: Fix Extraction Refinement Prompt - Allow Logic Changes - 2025-11-18 22:33

- **DONE: Removed misleading constraint from extraction refinement prompt** - Removed "Keep the same SMT-LIB logic" from refinement prompt which could prevent fixing incorrect or incomplete logic. **Implementation:** Rewrote refinement prompt in `src/infrastructure/llm/client.py:215-230` to explicitly allow and encourage logic changes. New prompt includes 6-step checklist: (1) review if logic captures ALL constraints, (2) check for missing constraints, (3) verify variable declarations, (4) fix logical errors, (5) add detailed comments, (6) include variable context. Emphasizes that LLM should change logic AND/OR annotations as needed. **Rationale:** Degradation measures embedding similarity - if logic is wrong, comments won't fix it. Previous prompt was counterproductive by restricting changes to annotations only.

## ✅ COMPLETED: Conversation-Based Refinement for Extraction - 2025-11-18 22:25

- **DONE: Implemented refinement logic for extraction retries** - Extraction now uses conversation-based refinement matching formalization pattern. **Implementation:** Added previous_attempt and previous_degradation parameters to LLMProvider.extract_to_smtlib protocol (`src/domain/protocols.py:56-77`). Updated AnthropicClient.extract_to_smtlib (`src/infrastructure/llm/client.py:162-248`) to build 3-message conversation on retry: initial prompt → previous SMT code → refinement feedback with degradation score and guidance. Updated extraction.py retry loop (`src/domain/steps/extraction.py:85-138`) to track and pass previous attempts. Temperature stays 0.0 for deterministic code generation. **Benefits:** Better convergence through iterative refinement vs simple regeneration, maintains context across retries, explicit feedback guides LLM to reduce information loss.

## ✅ COMPLETED: Use Exact 5-Phase SMT Prompt - 2025-11-18 22:12

- **DONE: Replaced EXTRACTION_PROMPT with exact 5-phase prompt** - The exact battle-tested 5-phase prompt from convert_to_smtlib function has been implemented verbatim in `src/infrastructure/llm/prompts.py:18-98`. The prompt enforces: Phase 1 (problem comprehension with data inventory), Phase 2 (domain modeling with ground truth vs unknowns, assert-and-test pattern for YES/NO), Phase 3 (logic selection decision tree), Phase 4 (SMT-LIB encoding with uninterpreted function linking constraints), Phase 5 (self-verification checklist). Only change made: replaced `{enhanced_text}` placeholder with `{formal_text}` to match our variable naming. Function `get_extraction_prompt()` updated to use new prompt (detail_level parameter deprecated but kept for API compatibility).