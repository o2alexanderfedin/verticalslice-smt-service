# TO-DOS

## Fix Extraction Skip Logic - Accept First Attempt - 2025-11-18 22:58

- **Fix skip_retries logic to actually accept first attempt regardless of degradation** - The skip optimization logs "Will accept first extraction attempt without retries" but still fails when degradation > threshold. **Problem:** Log shows "Attempt 1: degradation=0.7667 (max=0.05)" followed by "Extraction failed after 5 attempts" even though max_attempts=1 and skip_retries=True. The code sets max_attempts=1 correctly but still returns Err when degradation exceeds threshold. For short inputs with skip_retries=True, we should accept the first attempt **regardless of degradation score** - that's the whole point of skipping quality checks for simple inputs. **Files:** `src/domain/steps/extraction.py:127-139` (threshold check inside loop), `src/domain/steps/extraction.py:149-157` (error return after loop). **Solution:** When skip_retries=True, bypass the degradation threshold check (lines 133-139) and immediately return Ok with the first attempt. The threshold check should only apply when NOT skipping retries. Add condition: `if degradation <= self.max_degradation or skip_retries:` at line 133.

## ✅ COMPLETED: Skip Extraction Refinement for Short Formal Texts - 2025-11-18 22:48

- **DONE: Added fast-path for short formal texts to skip extraction retries** - Short, simple formal texts now skip the retry loop for performance. **Implementation:** Added `extraction_skip_retries_threshold` config (`src/shared/config.py:116-121`, default 50 chars). Updated `ExtractionStep.__init__` to accept skip_retries_threshold parameter. Added skip logic in execute method (`src/domain/steps/extraction.py:86-97`) that checks formal_text length and sets max_attempts=1 if below threshold. Updated retry loop to use max_attempts and log skip_retries status. Pipeline service passes config to ExtractionStep. **Benefits:** Saves API calls for simple inputs (1 attempt vs up to 5), reduces latency, still computes degradation for metrics. **Example:** "x > 5" (5 chars) skips retries, but "The variable x must be greater than 5 and less than 10" (50+ chars) uses full refinement.

## ✅ COMPLETED: Enforce Zero Temperature for Extraction - 2025-11-18 22:19

- **DONE: Verified and documented extraction temperature stays at 0.0** - Confirmed extraction uses deterministic temperature (0.0) for all attempts with no variations. **Verification:** (1) Temperature hardcoded to 0.0 in `src/infrastructure/llm/client.py:238`, (2) No extraction temperature settings exist in `src/shared/config.py`, (3) Retry loop in `src/domain/steps/extraction.py` does not pass temperature parameter - only detail_level varies. **Documentation added:** Added CRITICAL warning in extract_to_smtlib docstring emphasizing temperature is non-configurable by design, expanded inline comment to 3-line warning at temperature=0.0 assignment, added NOTE in retry loop documenting temperature stays constant across all attempts. **Rationale:** Unlike formalization, extraction must be deterministic to ensure consistent, reproducible SMT-LIB output.

## ✅ COMPLETED: Fix Extraction Refinement Prompt - Allow Logic Changes - 2025-11-18 22:33

- **DONE: Removed misleading constraint from extraction refinement prompt** - Removed "Keep the same SMT-LIB logic" from refinement prompt which could prevent fixing incorrect or incomplete logic. **Implementation:** Rewrote refinement prompt in `src/infrastructure/llm/client.py:215-230` to explicitly allow and encourage logic changes. New prompt includes 6-step checklist: (1) review if logic captures ALL constraints, (2) check for missing constraints, (3) verify variable declarations, (4) fix logical errors, (5) add detailed comments, (6) include variable context. Emphasizes that LLM should change logic AND/OR annotations as needed. **Rationale:** Degradation measures embedding similarity - if logic is wrong, comments won't fix it. Previous prompt was counterproductive by restricting changes to annotations only.

## ✅ COMPLETED: Conversation-Based Refinement for Extraction - 2025-11-18 22:25

- **DONE: Implemented refinement logic for extraction retries** - Extraction now uses conversation-based refinement matching formalization pattern. **Implementation:** Added previous_attempt and previous_degradation parameters to LLMProvider.extract_to_smtlib protocol (`src/domain/protocols.py:56-77`). Updated AnthropicClient.extract_to_smtlib (`src/infrastructure/llm/client.py:162-248`) to build 3-message conversation on retry: initial prompt → previous SMT code → refinement feedback with degradation score and guidance. Updated extraction.py retry loop (`src/domain/steps/extraction.py:85-138`) to track and pass previous attempts. Temperature stays 0.0 for deterministic code generation. **Benefits:** Better convergence through iterative refinement vs simple regeneration, maintains context across retries, explicit feedback guides LLM to reduce information loss.

## ✅ COMPLETED: Use Exact 5-Phase SMT Prompt - 2025-11-18 22:12

- **DONE: Replaced EXTRACTION_PROMPT with exact 5-phase prompt** - The exact battle-tested 5-phase prompt from convert_to_smtlib function has been implemented verbatim in `src/infrastructure/llm/prompts.py:18-98`. The prompt enforces: Phase 1 (problem comprehension with data inventory), Phase 2 (domain modeling with ground truth vs unknowns, assert-and-test pattern for YES/NO), Phase 3 (logic selection decision tree), Phase 4 (SMT-LIB encoding with uninterpreted function linking constraints), Phase 5 (self-verification checklist). Only change made: replaced `{enhanced_text}` placeholder with `{formal_text}` to match our variable naming. Function `get_extraction_prompt()` updated to use new prompt (detail_level parameter deprecated but kept for API compatibility).